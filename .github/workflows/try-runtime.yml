name: Try Runtime

on:
  workflow_dispatch:
    inputs:
      chain:
        description: 'Chain to run try-runtime against'
        required: false
        default: 'testnet'
        type: choice
        options:
          - testnet
          - mainnet

permissions:
  contents: read

concurrency:
  group: try-runtime-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-runtime:
    name: Build Runtime
    runs-on: gh-ubuntu-2404-x64
    timeout-minutes: 90
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.81.0
          components: rustfmt, clippy
          target: wasm32-unknown-unknown
          override: true
          default: true

      - name: Restore cargo cache - common
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-common-${{ hashFiles('**/Cargo.lock') }}

      - name: Restore cargo cache - try-runtime
        uses: actions/cache@v4
        with:
          path: |
            target/
          key: ${{ runner.os }}-cargo-try-runtime-${{ hashFiles('**/Cargo.lock') }}

      - name: Build runtime with try-runtime
        run: cargo build --locked --release --features try-runtime -p tnf-node-runtime

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-wasm
          path: ./target/release/wbuild/tnf-node-runtime/tnf_node_runtime.compact.compressed.wasm
          retention-days: 1

  test-runtime-upgrade:
    name: Test Runtime Upgrade
    runs-on: gh-ubuntu-2404-x64
    timeout-minutes: 90
    needs: build-runtime
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download runtime artifact
        uses: actions/download-artifact@v4
        with:
          name: runtime-wasm
          path: ./runtime

      - name: Set chain WSS URL
        id: set-wss-url
        run: |
          case "${{ github.event.inputs.chain || 'testnet' }}" in
            "testnet")
              echo "wss_url=wss://chain-external.testnet.truth-network.io:443" >> $GITHUB_OUTPUT
              ;;
            "mainnet")
              echo "wss_url=wss://chain-external.truth-network.io:443" >> $GITHUB_OUTPUT
            *)
              ;;
          esac

      - name: Run try-runtime
        uses: NodleCode/action-try-runtime@v0.5.1
        with:
          url: ${{ steps.set-wss-url.outputs.wss_url }}
          runtime: ./runtime/tnf_node_runtime.compact.compressed.wasm
          checks: all

  test-features:
    name: Test Features
    runs-on: gh-ubuntu-2404-x64
    timeout-minutes: 90
    needs: build-runtime
    strategy:
      fail-fast: false
      matrix:
        features: [try-runtime, "try-runtime,runtime-benchmarks"]
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.81.0
          components: rustfmt, clippy
          target: wasm32-unknown-unknown
          override: true
          default: true

      - name: Restore cargo cache - common
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-common-${{ hashFiles('**/Cargo.lock') }}

      - name: Restore cargo cache - features
        uses: actions/cache@v4
        with:
          path: |
            target/
          key: ${{ runner.os }}-cargo-features-${{ hashFiles('**/Cargo.lock') }}

      - name: Build runtime with features
        run: |
          cargo build --locked --release --features ${{ matrix.features }} -p tnf-node-runtime

      - name: Set chain WSS URL for features test
        id: set-wss-url-features
        run: |
          CHAIN="${{ github.event.inputs.chain || 'testnet' }}"
          case "$CHAIN" in
            "testnet")
              echo "wss_url=wss://chain-internal.testnet.truth-network.io:443" >> $GITHUB_OUTPUT
              ;;
            "mainnet")
              echo "wss_url=wss://chain-internal.truth-network.io:443" >> $GITHUB_OUTPUT
              ;;
            *)
          esac

      - name: Run try-runtime with features
        uses: NodleCode/action-try-runtime@v0.5.1
        with:
          url: ${{ steps.set-wss-url-features.outputs.wss_url }}
          runtime: ./target/release/wbuild/tnf-node-runtime/tnf_node_runtime.compact.compressed.wasm
          checks: all

  validate-integration:
    name: Validate Integration
    runs-on: gh-ubuntu-2404-x64
    timeout-minutes: 90
    needs: [build-runtime, test-runtime-upgrade, test-features]
    if: always()
    steps:
      - name: Validate integration
        run: |
          echo "=== Try-Runtime Validation Results ==="
          echo "Build: ${{ needs.build-runtime.result }}"
          echo "Runtime upgrade tests: ${{ needs.test-runtime-upgrade.result }}"
          echo "Feature tests: ${{ needs.test-features.result }}"
          echo ""
          
          # Check if any job failed
          if [ "${{ needs.build-runtime.result }}" != "success" ]; then
            echo "Build job failed!"
            exit 1
          fi
          
          if [ "${{ needs.test-runtime-upgrade.result }}" != "success" ]; then
            echo "Runtime upgrade tests failed!"
            exit 1
          fi
          
          if [ "${{ needs.test-features.result }}" != "success" ]; then
            echo "Feature tests failed!"
            exit 1
          fi
          
          echo "All try-runtime tests passed successfully!" 